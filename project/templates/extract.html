<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extraction Results - Multi-Format Intake System</title>
    <link href="/static/style.css" rel="stylesheet">
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body>
    <div id="app" x-data="extractApp()">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-content">
                <div class="nav-left">
                    <h1 class="nav-title">Multi-Format Intake System</h1>
                </div>
                <div class="nav-center">
                    <a href="/" class="nav-link">Home</a>
                    <a href="/history" class="nav-link">History</a>
                    <a href="/memory" class="nav-link">Memory</a>
                </div>
                <div class="nav-right">
                    <div class="user-menu" x-data="{ open: false }">
                        <button @click="open = !open" class="user-avatar">
                            <svg class="user-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                        </button>
                        <div x-show="open" @click.away="open = false" class="user-dropdown">
                            <button class="dropdown-item">Edit User</button>
                            <button class="dropdown-item">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="extraction-container">
                <div class="extraction-header">
                    <h2>Extraction Results</h2>
                    <div class="file-info">
                        <span class="filename">{{ filename }}</span>
                        <span class="classification">{{ classification }}</span>
                    </div>
                </div>

                <div class="extraction-content">
                    <!-- Left Side - Uploaded File Preview -->
                    <div class="file-preview">
                        <h3>Uploaded File</h3>
                        <div class="preview-content">
                            <div class="file-icon">
                                <svg fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                </svg>
                            </div>
                            <p class="file-name">{{ filename }}</p>
                            <p class="file-type">Type: {{ classification }}</p>
                        </div>
                    </div>

                    <!-- Right Side - Extracted Data -->
                    <div class="extracted-data">
                        <h3>Extracted Data</h3>
                        <div class="data-content">
                            <pre class="json-display">{{ extracted_data }}</pre>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="save-section">
                    <button @click="saveToDataset()" :disabled="saving" class="save-btn">
                        <span x-show="!saving">Save to Dataset</span>
                        <span x-show="saving" class="loading-spinner">Saving...</span>
                    </button>
                </div>

                <!-- Error Messages -->
                <div x-show="error" class="error-message" x-text="error"></div>
            </div>
        </main>

        <!-- Success Popup -->
        <div x-show="showSuccess" class="success-popup">
            <div class="success-content">
                <svg class="success-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                </svg>
                <span>Data successfully saved to dataset!</span>
            </div>
        </div>
    </div>

    <script>
        function extractApp() {
            return {
                saving: false,
                error: '',
                showSuccess: false,

                async saveToDataset() {
                    this.saving = true;
                    this.error = '';

                    try {
                        const response = await fetch('/api/save-dataset', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                file_id: '{{ file_id }}',
                                extracted_data: JSON.parse('{{ extracted_data | safe }}')
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            this.showSuccess = true;
                            setTimeout(() => {
                                this.showSuccess = false;
                            }, 3000);
                        } else {
                            this.error = result.message || 'Failed to save data';
                        }
                    } catch (error) {
                        this.error = 'Network error occurred';
                        console.error('Save error:', error);
                    } finally {
                        this.saving = false;
                    }
                }
            }
        }
    </script>
</body>
</html>